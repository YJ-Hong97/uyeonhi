<!DOCTYPE html>
<html xmlns:th="http://www.tymeleaf.org">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Libre+Barcode+39+Text&display=swap"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<style>
body {
	position: relative;
	margin: 0 auto;
	width: 100%;
	height: 100%;
	background-color: black;
	text-align: center;
	box-sizing: border-box;
	font-family: 'Gowun Dodum';
	font-style: normal;
	font-weight: 400;
	font-size: 1.5rem;
	line-height: 110%;
	text-align: center;
}

body div {
	display: inline-block;
}

.videoContainer {
	position: absolute;
	top: 0;
	left: 50%;
	transform: translate(-50%, 0);
	width: 40%;
	overflow: hidden;
	z-index: 1;
}

.videoContainer #remoteVideo {
	position: relative;
	width: auto;
	height: 100vh;
	z-index: 1;
	overflow: hidden;
	z-index: 2;
}

.videoContainer #localVideo {
	position: absolute;
	top: 90%;
	left: 20%;
	transform: translate(-50%, -50%);
	width: auto;
	height: 30vh;
	z-index: 5;
}

.chatContainer {
	width: 30%;
	height: 100vh;
	float: left;
}

.chatBox {
	width: 80%;
	height: 80vh;
	margin-top: 10%;
	border-radius: 1rem;
	margin-top: 1%;
	border-radius: 1rem;
	background-color: rgba(255, 255, 255, 0.4);
}

.chatBox #message {
	width: 70%;
	border: 0;
	border-radius: 0.5rem;
	background-color: white;
}

.chatBox #sendBtn {
	width: 20%;
	border: 0;
	border-radius: 0.5rem;
	background-color: #B983FF;
	color: white;
}

.chatBox .messageBox {
	height: 27rem;
}

.chatBox .inputBox {
	width: 100%;
	float: bottom;
}

.chatContainer span {
	display: block;
	color: white;
	margin-bottom: 0;
	margin-top: 5%;
	margin-left: 10%;
	text-align: left;
}

.timeContainer {
	position: absolute;
	top: 0;
	left: 85%;
	transform: translate(-50%, 0);
	width: 28%;
	height: 100vh;
	color: white;
}

.timeContainer span {
	margin-top: 10%;
	color: #B983FF;
	font-size: 6rem;
}

.timeContainer .timeBox {
	margin-top: 50%;
}

.messageBox {
	width: 90%;
	height: 90%
}

#connect {
	cursor: pointer;
}
</style>
<body>
	<div class="chatContainer">
		<span class="material-symbols-outlined"> send </span>
		<div class="chatBox">
			<div class="messageBox"></div>
			<div class="inputBox">
				<input text id="message">
				<button type="button" id="sendBtn">전송</button>
			</div>
		</div>
	</div>
	<div class="videoContainer">
		<video id="remoteVideo" autoplay playsinline></video>
		<video id="localVideo" autoplay playsinline></video>


	</div>
	<div class="timeContainer">
		<div class="timeBox">
			<p id="time"></p>
			<p>ooo님과 이만큼 통화 중!</p>
			<span class="material-symbols-rounded" id="connect">
				phone_in_talk </span>
		</div>
	</div>
	<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	<script th:inline="javascript">
	/*<![CDATA[*/
	var sock = new SockJS('/video');
	var inputData = "";
	var message = "";
	var stomp;
	var remoteVideo = document.querySelector('#remoteVideo');
	var localVideo = document.querySelector('#localVideo');

	var mid = /*[[${user.id}]]*/'default';
	var roomNo = /*[[${room.roomNo}]]*/'default';
	var sendData = {
			"mid":mid
	}
	
	stomp = Stomp.over(sock);
	console.log(stomp);
	stomp.connect({},function(){
		//접속자 받아오기
		stomp.subscribe(`/sub/video/joined-room-info/${roomNo}`,function(data) {
			console.log(data);
			var users = JSON.parse(data.body);
			var topIdx = users.length-1;
			var joinedId = users[topIdx];
			if(topIdx>=1) return secondPeer();
			 initPeer(joinedId);
		})
		//접속 알리기
		stomp.send("/pub/video/joined-room-info/"+roomNo,{},{
			from:sendData["mid"],
			at:roomNo
		});
	});
	
	//신입에게 인사하기
	function initPeer(joinedId){
		console.log("초기자");
		const peer = new SimplePeer({
			initiator:true,
			trickle:false,
		});
		peer.on('signal',function(data){
			let edata = JSON.stringify(data);
			//console.log(1,edata)
			edata =edata.replaceAll("\\","**");
			//console.log(2,edata)
 			stomp.send(`/pub/video/caller-info/${roomNo}`,{},edata);
		});
		peer.on("stream",function(stream){
			remoteVideo.srcObject = stream;
		});
		navigator.mediaDevices.getUserMedia({
			video:true
		}).then((stream)=>{
			localVideo.srcObject = stream;
		})
		stomp.subscribe(`/sub/video/callee-info/${roomNo}`,function(data){
			var edata = JSON.stringify(data.body); 
			edata =edata.replaceAll("**","\\");
			obj = JSON.parse(edata);
			console.log(obj);
			peer.signal(obj);
		});
	}

	
	function secondPeer(){
		
		const peer = new SimplePeer({
			initiator:false,
			trickle:false,
		});
		console.log("두번째");
		console.log(peer);
		peer.on("signal",function(data){
			let edata = JSON.stringify(data);
			//console.log(1,edata)
			edata =edata.replaceAll("\\","**");
			//console.log(2,edata)
			stomp.send(`/pub/video/callee-info/${roomNo}`,{},JSON.stringify({
				at:roomNo,
				signal:edata
			}));
		});
		
		peer.on("stream",function(stream){
			remoteVideo.srcObject = stream;
		});
		navigator.mediaDevices.getUserMedia({
			video:true
		}).then((stream)=>{
			localVideo.srcObject = stream;
		})
		stomp.subscribe(`/sub/video/caller-info/${roomNO}`,{},function(data){
			var edata = JSON.stringify(data.body); 
			edata =edata.replaceAll("**","\\");
			obj = JSON.parse(edata);
			console.log(obj);
			peer.signal(obj);
		});
	};
	
	
	
	
	
//시간 체크
var hour = 0;
var min = 0;
var sec = 0;
 
  window.onload = function(){
	 
	 setInterval(function(){
		if(sec == 60 && min!=60){
			sec = 0;
			min +=1;
		}else if(sec ==60&& min==60){
			sec= 0;
			min=0;
			hour +=1;
		}else {
			sec +=1;
		}
	$('#time').html(`<span>${hour}:</span>
	<span>${min}:</span>
	<span>${sec}</span>`);
		
	 },1000);
  }
  /*]]>*/
</script>
</body>
</html>